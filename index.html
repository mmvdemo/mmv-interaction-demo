<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
    </head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <body>
        <canvas id="mycanvas" />
        <script type="text/javascript">
        //load data
        const technique = "<%= technique%>";
        let getValue,data={},destinations=[],nodeCnt;
        const timeStart = Number("<%= timeStart%>");
        const timeEnd= Number("<%= timeEnd%>");
        const dataType = "<%= dataType%>";
        if(dataType == "RANDOM") {
            nodeCnt = Number("<%= nodeCnt%>");
            for(let t=timeStart;t<=timeEnd;t++) {
                let matrix = [];
                for(let i=0;i<nodeCnt;i++) {
                    matrix.push(d3.range(nodeCnt).map(Math.random));
                }
                data[t] = matrix;
            }
            getValue = function(timeIdx,h,w) {
                return data[timeIdx][h][w];
            };
        } else if(dataType == "US") {
            let json = <%- data%>;
            for(let t=timeStart;t<=timeEnd;t++) {
                data[`${t}`] = JSON.parse(json[`${t}`]);
            }
            for(let i=0;i<data[timeEnd].length;i++) {
                destinations.push(data[timeEnd][i]['Destinations']);
            }
            nodeCnt = destinations.length;
            //normalize data
            let maxValue = 0;
            for(let i=0;i<data[timeEnd].length;i++) {
                for(let j=0;j<destinations.length;j++) {
                    let value = data[timeEnd][i][destinations[j]];
                    if(value.length>0) {
                        if(maxValue<Number(value)) {
                            maxValue = Number(value);
                        }
                    }
                }
            }
            maxValue /=8;
            getValue = function(timeIdx,h,w) {
                const value =data[timeIdx][h][destinations[w]];
                if(value.length==0) {
                    return 0;
                } else {
                    const ans = Number(value)/maxValue;
                    return ans;
                }
            };
        }
        </script>
        <script type="module" src="./src/parameters.js"></script>
        <script type="module" src="./src/utils.js"></script>
        <script type="module"> 
            import {loadCartesianLens} from "./src/cartesianLens.js";
            import {loadTableLens} from "./src/tableLens.js";
            import {loadFisheyeLens} from "./src/fisheyeLens.js";
            import {loadZoom} from "./src/zoom.js";
            if(technique == "cartesianlens") {
                loadCartesianLens();
            } else if(technique == "tablelens") {
                loadTableLens();
            } else if(technique == "fisheyelens") {
                loadFisheyeLens();
            } else if(technique == "zoom") {
                loadZoom();
            } else if(technique == "inset") {
            }
        </script>
    </body>
</html>
