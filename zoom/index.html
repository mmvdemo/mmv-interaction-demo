<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Zoom</title>
    </head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"</script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <body>
        <canvas id="mycanvas" />
        <script type="text/javascript">
                
        //load data
       
        let nodeCnt = 50;
        let timeStart = 2012, timeEnd = 2019;
        
        //color
        let backgroundColor = 0x707B7C;
        let headColor = 0x85C1E9; 
        let nodeColor = 0x1ABC9C;
        let selectColor = 0xE74C3C;
        let lineColor = 0x2E4053;
        //parameters
        let stageWidth = 800, stageHeight = 800;
        let tableWidth = nodeCnt, tableHeight = nodeCnt;
        let focalScale = 4;
        let stepWidth = stageWidth/tableWidth,stepHeight = stageHeight/tableHeight;
        let chartRatio=0.8;
        let nodeRadius =0.2; 
        let showChart = false;
        //init app
        const container = new PIXI.Container();
        let canvas = document.getElementById("mycanvas");
        let app = new PIXI.Application({width:stageWidth, height:stageHeight, antialias:true, view:canvas});
        app.renderer.backgroundColor = backgroundColor;
        //document.body.appendChild(app.view);
        app.stage.interactive = true;
        app.stage.addChild(container);
        //generate texture
        let rect = new PIXI.Graphics();
        rect.beginFill(0xFFFFFF);
        rect.drawRect(0,0,stepWidth,stepHeight);
        rect.endFill();
        const texture =app.renderer.generateTexture(rect);
        
        window.onload = loadTable();

        let d3canvas = d3.select("#mycanvas");
        d3canvas.call(d3.zoom().scaleExtent([1, 8]).on("zoom", zoom));
        function zoom() {
            //console.log(parseInt(PIXI.Ticker.shared.FPS)+' FPS');
            var x = d3.event.transform.x;
            var y = d3.event.transform.y;
            var scale = d3.event.transform.k;
            container.x = x;
            container.y = y;
            container.scale.x = scale;
            container.scale.y = scale;
            if(scale>focalScale && showChart ==false){
                showChart=true;
                updateChartVisiblity(true);
            } else if(scale<focalScale && showChart ==true) {
                showChart = false;
                updateChartVisiblity(false);
            }
        }
        function loadTable() {
            for(var i =0;i<tableWidth;i++) {
                for(var j=0;j<tableHeight;j++) {
                    let grid = new PIXI.Sprite(texture);
                    let value = getValue(timeEnd,i,j);
                    let colorStr = d3.interpolateYlGn(value);
                    let color = rgbStrToHex(colorStr);
                    grid.tint = color;
                    grid.x = i*stepWidth;
                    grid.y = j*stepHeight;
                    grid.chart = drawChartGraphics(i,j);
                    grid.addChild(grid.chart);
                    container.addChild(grid);
                }
            }
        }
        function rgbStrToHex(s) {
            let pat = new RegExp("\\d+","g");
            let numbers = s.match(pat);
            let color = 0x0;
            for (var i=0;i<3;i++) {
                color += Number(numbers[i])*Math.pow(256,2-i);
            }
            return color; 
        }
        function drawChartGraphics(i,j) {
            let values = [];
            for(var t=timeStart;t<=timeEnd;t++) {
                values.push(getValue(t,i,j));
            }
            let chart = new PIXI.Graphics();
            chart.visible = false;
            var chartHeight = stepHeight*chartRatio;
            var chartWidth = stepWidth*chartRatio;
            chart.x = (stepWidth-chartWidth)/2;
            chart.y = (stepHeight-chartHeight)/2;
            chart.lineStyle(0.2,lineColor,1)
                        .moveTo(0,chartHeight)
                        .lineTo(chartWidth,chartHeight);
            chart.lineStyle(0.2,lineColor,1)
                        .moveTo(0,chartHeight)
                        .lineTo(0,0);
            var timeLen = timeEnd-timeStart;
            var lastX=-1,lastY=-1;
            for(var t=timeStart;t<=timeEnd;t++) {
                var value = getValue(t,i,j);
                var xPos = chartWidth*(t-timeStart)/timeLen;
                var yPos = chartHeight*(1-value);
                chart.beginFill(nodeColor);
                chart.drawCircle(xPos,yPos,nodeRadius);
                chart.endFill();
                if(lastX>=0) {
                    chart.lineStyle(0.2,lineColor,1)
                        .moveTo(lastX,lastY)
                        .lineTo(xPos,yPos);
                }
                lastX=xPos;
                lastY=yPos;
            }
            return chart;
        }
        function updateGridRenderability() {
            for (var i=0;i<tableWidth;i++) {
                for(var j=0;j<tableHeight;j++) {
                    var grid = getGridSprite(i,j); 
                    grid.renderable = inScreen(grid);
                    grid.chart.renderable = grid.renderable;
                }
            }
        }
        function updateChartVisiblity(signal) {
            for (var i=0;i<tableWidth;i++) {
                for(var j=0;j<tableHeight;j++) {
                    var grid = getGridSprite(i,j); 
                    grid.chart.visible = signal;
                }
            }
        }
        function getGridSprite(i,j) {
            return container.children[i*tableHeight+j];
        }
        function inScreen(grid) {
            var pos = child.toGlobal(new PIXI.Point(0,0));
            return (pos.x > 0 && pos.y > 0 && pos.x < stageWidth && pos.y < stageHeight);
        }
        function getValue(timeIdx,i,j) {
            return Math.random();
        }

        </script>
    </body>
</html>
